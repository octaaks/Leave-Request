@{
    Layout = (string)ViewData["Layout"] ?? "_LayoutUser";
    ViewData["Title"] = "Request";
}
<html>
<head>
    <title>Title</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<link href="~/fontawesome/css/all.css" rel="stylesheet">--> <!--load all styles -->
    <!-- CSS Boostrap -->
    @*<link rel="styles heet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.css">*@

    <!-- CSS Bootstrap Datepicker -->
    @*<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.6/css/buttons.dataTables.min.css">*@
    @*<link rel="stylesheet" href="~/css/persons.css" />*@
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.css">

</head>
<body>
    <div class="container">
        <div class="row">
            @*<div class="col">
                <h3 id="judul" text-align:start;">Leave Request History</h3>
            </div>*@
            <div class="col">
                <button class="btn btn-primary ml-3" style="float:right" data-bs-toggle="modal" data-bs-target="#registerModal">New Request <i class="fas fa-plus ml-2"></i></button>
            </div>
        </div>

        <div class="card shadow p-3 mt-3 p-lg-3">
            <h2 class="card-title text-center mb-5" style="font-weight:bold" id="judul" sstyle="text-align:start;">Leave Request History</h2>
            <table id="table_id" class="display nowrap hover" style="width:100%">
                <thead>
                    <tr>
                        <th>NO</th>
                        <th>Req. At</th>
                        <th>Leave Type</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Apr. At</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div class="card-footer mt-5">
                <p style="font-weight:bold">Leave types in company:</p>
                <div class="row">
                    <div class="col-sm-3">
                        <ol class="ml-4">
                            <li> Annual Leave</li>
                            <li> Marriage Leave</li>
                            <li> Maternity Leave</li>
                            <li> Medical Leave</li>
                            <li> Sudden-death Leave</li>
                        </ol>
                    </div>
                    <div class="col-9">
                        <ul class="mr-5" style="list-style-type: none;">
                            <li> :  12 days/years, can only be taken after 12 months work for company</li>
                            <li> :  3 days working days</li>
                            <li> :  40 days working days</li>
                            <li> :  Adjust doctor's recommendation</li>
                            <li> :  1 days working days</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal 1-->
        <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div id="modal-content" class="modal-body">
                        <div class="row">
                            <div class="col-4 pl-5 font-weight-bold">

                                <div>Employee ID</div>
                                <div>Name</div>
                                <div>Leave Type</div>
                                <div>Approver</div>
                                <div>Start Date</div>
                                <div>End Date</div>
                                <div>Notes</div>

                            </div>
                            <div class="col-1">
                                <div>:</div>
                                <div>:</div>
                                <div>:</div>
                                <div>:</div>
                                <div>:</div>
                                <div>:</div>
                                <div>:</div>
                            </div>
                            <div class="col-7">
                                <div id="modal-data"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Request Form-->
        <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">New Leave Request</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div id="modal-content" class="modal-body p-5">
                        <form id="contactform" class="needs-validation" novalidate>
                            @*<form method="post" action="" id="contactform" class="was-validated">*@

                            @*<div class="form-row">
                                <div class="col-4 mb-3">
                                    <label for="inputId">Employee ID</label>
                                </div>
                                <div class="col mb-3">
                                    <div class="input-group">
                                        <input type="text" name="nik" class="form-control" id="inputId" placeholder="Employee ID" aria-describedby="" value="@ViewData["Id"]" autocomplete="off" readonly>
                                        <p class="validation-message" id="invalid-nik"></p>
                                        <div class="invalid-feedback">
                                            Please type your ID.
                                        </div>
                                    </div>
                                </div>
                            </div>*@
                            <div class="form-row">
                                <div class="col-4 mb-3">
                                    <label for="inputApprover">Approver</label>
                                </div>
                                <div class="col-md mb-3">
                                    <div class="input-group">
                                        <select class="custom-select my-1 mr-sm-2" id="inputApprover" placeholder="Approver" required>
                                            <option value=0>Select approver</option>
                                        </select>
                                        <div class="invalid-feedback">
                                            Please select the approver.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-4 mb-3">
                                    <label for="inputLeaveType">Leave Type</label>
                                </div>
                                <div class="col-md mb-3">
                                    <div class="input-group">
                                        <select class="custom-select my-1 mr-sm-2" id="inputLeaveType" placeholder="Leave Type" required>
                                            <option value=0>Select leave type</option>
                                        </select>
                                        <div class="invalid-feedback">
                                            Please select the leave type.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-4 mb-3">
                                    <label>Date Range</label>
                                </div>
                                <div class="col-md mb-3">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <div class="input-group-text"><i class="fas fa-calendar-alt"></i></div>
                                        </div>
                                        <input type="text" class="form-control" data-date-format="yyyy-mm-dd" id="inputStartDate" placeholder="Start Date" autocomplete="off" autocorrect="off"
                                               autocapitalize="off" spellcheck="false" required>
                                        <div class="input-group-addon">
                                            <span class="glyphicon glyphicon-th"></span>
                                        </div>
                                        <div class="invalid-feedback">
                                            Please insert the start date.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md mb-3">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <div class="input-group-text"><i class="fas fa-calendar-alt"></i></div>
                                        </div>
                                        <input type="text" class="form-control" data-date-format="yyyy-mm-dd" id="inputEndDate" placeholder="End Date" autocomplete="off" autocorrect="off"
                                               autocapitalize="off" spellcheck="false" required>
                                        <div class="input-group-addon">
                                            <span class="glyphicon glyphicon-th"></span>
                                        </div>
                                        <div class="invalid-feedback">
                                            Please insert the end date.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="col-4 mb-3">
                                    <label for="">Holidays</label>

                                </div>
                                <div class="col-md mb-3">
                                    <input type="number" class="form-control" id="holidays" placeholder="Holidays" autocomplete="off" autocorrect="off"
                                           autocapitalize="off" spellcheck="false" readonly>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-4 mb-3">
                                    <label for="">Duration From Leave Type</label>

                                </div>
                                <div class="col-md mb-3">
                                    <input type="number" class="form-control" id="leaveTypeDuration" placeholder="0" autocomplete="off" autocorrect="off"
                                           autocapitalize="off" spellcheck="false" readonly>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-4 mb-3">
                                    <label for="">Leave Duration</label>

                                </div>
                                <div class="col-md mb-3">
                                    <input type="number" class="form-control" id="leaveDuration" placeholder="Leave Duration" autocomplete="off" autocorrect="off"
                                           autocapitalize="off" spellcheck="false" readonly>
                                </div>
                            </div>

                            @*<div class="form-group mt-3">
            <div class="form-check">
                <input class="form-check-input" name="univId" type="checkbox" value="" id="invalidCheck" required>
                <label class="form-check-label" for="invalidCheck">
                    Agree to terms and conditions
                </label>
                <div class="invalid-feedback">
                    You must agree before submitting.
                </div>
            </div>
        </div>*@

                            @*<button id="register" class="btn btn-primary" type="submit">Submit form</button>*@
                            <button class="btn btn-primary float-right mt-5" type="submit" id="btnSubmit">Submit form</button>
                        </form>
                    </div>
                    <!--<div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>-->
                    @*<button type="button" class="btn btn-primary">Save changes</button>*@
                    <!--</div>-->
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.flash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.js"></script>

<script>

    //datepicker functions

    var specialLeave = false;
    var startdate = "";
    var enddate = "";
    var duration = "";
    var holidays = 0;

    $(function () {
        $.ajax({
            url: "https://api-harilibur.vercel.app/api?year=" + moment().year(),
            success: function (result) {

                $('#inputStartDate').datepicker({
                    format: 'mm/dd/yyyy',
                    startDate: '-0m',
                    daysOfWeekDisabled: [0, 6]
                }).on('changeDate', function (e) {
                    startdate = e.format();
                    holidays = 0;

                    if (moment($("#inputStartDate").val()) > moment($("#inputEndDate").val())) {
                        $("#inputEndDate").datepicker("destroy");
                        $("#inputEndDate").val('');
                    }

                    if (specialLeave) {

                        $("#inputEndDate").datepicker("destroy");
                        var selected = $("select#inputLeaveType").children("option:selected").val();

                        $.ajax({
                            url: "/leavetypes/getall"
                        }).done((response) => {
                            enddate = moment(moment(startdate).add(response[selected - 1].duration - 1, 'days')).format("MM/DD/YYYY");

                            for (var i = 0; i < result.length; i++) {
                                if (moment(startdate) <= moment(result[i].holiday_date) && moment(result[i].holiday_date) <= moment(enddate)) {
                                    if (moment(result[i].holiday_date).day() != 0 || moment(result[i].holiday_date).day() != 0) {
                                        if (result[i].is_national_holiday == true) {
                                            holidays++;
                                            console.log(result[i].holiday_date, result[i].holiday_name);
                                        }
                                    }
                                }
                            }

                            duration = getNumWorkDays(moment(startdate), enddate) - holidays;

                            $("#inputEndDate").val(enddate);
                            $('#leaveDuration').val(duration);
                            $('#holidays').val(holidays);

                        }).fail((result) => {
                            console.log(result);
                        });

                    } else {

                        $("#inputEndDate").datepicker("destroy");
                        $('#inputEndDate').datepicker({
                            format: 'mm/dd/yyyy',
                            startDate: new Date(moment(startdate)),
                            daysOfWeekDisabled: [0, 6]
                        }).on('changeDate', function (e) {
                            enddate = e.format();
                            holidays = 0;


                            for (var i = 0; i < result.length; i++) {
                                if (moment(startdate) <= moment(result[i].holiday_date) && moment(result[i].holiday_date) <= moment(enddate)) {
                                    if (moment(result[i].holiday_date).day() != 0 || moment(result[i].holiday_date).day() != 0) {
                                        if (result[i].is_national_holiday == true) {
                                            holidays++;
                                            console.log(result[i].holiday_date, result[i].holiday_name);
                                        }
                                    }
                                }
                            }

                            duration = getNumWorkDays(moment(startdate), enddate) - holidays;
                            $('#leaveDuration').val(duration);
                            $('#holidays').val(holidays);
                        });

                        for (var i = 0; i < result.length; i++) {
                            if (moment(startdate) <= moment(result[i].holiday_date) && moment(result[i].holiday_date) <= moment(enddate)) {
                                if (moment(result[i].holiday_date).day() != 0 || moment(result[i].holiday_date).day() != 0) {
                                    if (result[i].is_national_holiday == true) {
                                        holidays++;
                                        console.log(result[i].holiday_date, result[i].holiday_name);
                                    }
                                }
                            }
                        }

                        duration = getNumWorkDays(moment(startdate), enddate) - holidays;
                        $('#leaveDuration').val(duration);
                        $('#holidays').val(holidays);
                    }
                });
            }
        });
    });

    //get leavetype duration

    $("select#inputLeaveType").change(function () {
        var selected = $(this).children("option:selected").val();

        $("#inputEndDate").val('');
        $("#inputStartDate").val('');
        $("#holidays").val('0');
        $("#leaveDuration").val('0');

        if (selected != 1) {
            document.getElementById('inputEndDate').setAttribute('readonly', true);
            specialLeave = true;
        } else {
            document.getElementById('inputEndDate').removeAttribute('readonly');
            specialLeave = false;
        }
        console.log(selected);

        $.ajax({
            url: "/leavetypes/getall"
        }).done((result) => {

            $("#leaveTypeDuration").val(result[selected - 1].duration);

        }).fail((result) => {
            console.log(result);
        });
    });

    //fetch all approver innto form dropdown

    $.ajax({
        url: "/accounts/GetApprovers"
    }).done((result) => {
        var text = "";
        console.log(result);
        $.each(result, function (key, val) {
            text += `
            <option value="${val.id}">${val.name}</option>
        `
        });
        $("#inputApprover").html(text);
    }).fail((result) => {
        console.log(result);
    });

    //fetch all leave types innto form dropdown

    $.ajax({
        url: "/leavetypes/getall"
    }).done((result) => {
        var text = "";
        console.log(result);
        $.each(result, function (key, val) {
            text += `
            <option value="${val.id}">${val.name}</option>
        `
        });
        $("#inputLeaveType").html(text);
    }).fail((result) => {
        console.log(result);
    });

    //get jumlah hari kerja dlm range

    function getNumWorkDays(startDate, endDate) {

        var numWorkDays = 0;
        var currentDate = moment(startDate);
        while (currentDate <= moment(endDate)) {
            // Skips Sunday and Saturday

            if (moment(currentDate).day() !== 0 && moment(currentDate).day() !== 6) {
                numWorkDays++;
            }
            currentDate = moment(currentDate).add(1,'days');
        }
        return numWorkDays;
    }

    //Leave Requests DATATABLEs

    var mt = $('#table_id').DataTable({
        "columnDefs": [{
            "targets": 0,
            "searchable": false,
            "orderable": false
        }],
        "order": [[1, 'desc']],
        "filter": true,
        "ajax": {
            "url": "/leaverequests/getemployeeleaverequests/" + parseInt('@ViewData["Id"]'),
            "datatype": "json",
            "dataSrc": ""
        },
        "columns": [
            { "data": null },
            {
                "data": "requestDate",
                "render": function (data, type, row) {
                    return moment(data).lang("id").format("DD/MM/YY HH:mm")
                }
            },
            {
                "data": "leaveTypeName"
            },
            {
                "data": "startDate",
                "render": function (data, type, row) {
                    return moment(data).format("DD/MM/YY")
                }
            },
            {
                "data": "endDate",
                "render": function (data, type, row) {
                    return moment(data).format("DD/MM/YY")
                }
            },
            { "data": "leaveDuration" },
            {
                "data": "statusId",
                "render": function (data, type, row) {
                    if (data == 3) {
                        return '<span class="badge badge-pill badge-danger"> Rejected </span>';
                    } else if (data == 2) {
                        return '<span class="badge badge-pill badge-success"> Accepted </span>';
                    } else if (data == 1){
                        return '<span class="badge badge-pill badge-warning"> Pending </span>';
                    }
                }
            },
            {
                "data": "approvedDate",
                "render": function (data, type, row) {
                    if (row['statusId'] == 2) {
                        return moment(data).lang("id").format("DD/MM/YY HH:mm");
                    } else {
                        return "-";
                    }
                }
            }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copyHtml5',
                exportOptions: {
                    columns: [1, 2, 3, 4, 5]
                }
            },
            {
                extend: 'excelHtml5',
                exportOptions: {
                    columns: [1, 2, 3, 4, 5]
                }
            },
            {
                extend: 'pdfHtml5',
                exportOptions: {
                    columns: [1, 2, 3, 4, 5]
                }
            },
        ]
    });

    //Column onclick action

    $('#table_id tbody').on('click', 'tr', function () {
        var data = mt.row(this).data();
        //alert('You clicked on ' + data.id + '\'s row');
        $("#detailsModal").modal('show');
        console.log(data);
        showDetails(data.id);
    });

    //first column

    mt.on('order.dt search.dt', function () {
        mt.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
            cell.innerHTML = i + 1;
        });
    }).draw();

    //reload datatable

    function reloadTable() {
        mt.ajax.reload(function (json) {
            $('#table_id').val(json.lastInput);
        });
    }

    //form validation

    (function () {
        'use strict';
        window.addEventListener('load', function () {
            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.getElementsByClassName('needs-validation');

            // Loop over them and prevent submission
            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Something went wrong!',
                        })
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === true) {
                        event.preventDefault();
                        var obj = {
                            "EmployeeId": parseInt('@ViewData["Id"]'),
                            "ApproverId": parseInt($('#inputApprover').val()),
                            "RequestDate": moment().format("YYYY/MM/DD HH:mm"),
                            "StartDate": moment($('#inputStartDate').val()).format("YYYY/MM/DD"),
                            "EndDate": moment($('#inputEndDate').val()).format("YYYY/MM/DD"),
                            "LeaveDuration": parseInt($('#leaveDuration').val()),
                            "LeaveTypeId": parseInt($('#inputLeaveType').val())
                        };

                        var data = JSON.stringify(obj);
                        insertRequest(data);
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    //show LR details
    function showDetails(id) {
        $.ajax({
            url: "/leaverequests/getbyid/" + id
        }).done((result) => {

            console.log("result", result);
            $.ajax({
                url: "/employee/GetEmployeeById/" + result.approverId
            }).done((res) => {
                console.log("res",res);
                var text = "";
                text += `
            <div>${result.employeeId}</div>
            <div>${result.employeeName}</div>
            <div>${result.leaveTypeName}</div>
            <div>${res.name}</div>
            <div>${moment(result.startDate).format("DD/MM/YY")}</div>
            <div>${moment(result.endDate).format("DD/MM/YY")}</div>
            <div>"${result.notes}"</div>
            `
                $("#modal-data").html(text);
                $("#exampleModalLabel").html("Leave Request Details");
            });

        }).fail((result) => {
            console.log(result);
        });
    }

    //submit and register
    function insertRequest(data) {
        console.log(data);

        $.ajax({
            type: "POST",
            url: "/leaverequests/addleaverequest",
            data: data,
            traditional: true,
            contentType: 'application/json',
            dataType: "json",

        }).done((result) => {
            console.log(result);

            //reset form and fields
            $('#registerModal').modal('toggle');
            $('#contactform')[0].reset();
            $('#contactform').removeClass('was-validated');
            $('#contactform').addClass('needs-validation');
            $('#inputId').val('@ViewData["Id"]');
            document.getElementById('inputEndDate').removeAttribute('readonly');

            //reload datatable only
            reloadTable();

            Swal.fire(
                'Congratulations!',
                'Register succeed!'
            );

        }).fail((result) => {
            console.log(result);
        });
    };
</script>